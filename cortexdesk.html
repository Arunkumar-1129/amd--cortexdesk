<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CortexDesk - Local AI Workspace</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        
        /* Sidebar */
        .sidebar { position: fixed; left: 0; top: 0; width: 250px; height: 100vh; background: #2c3e50; color: white; padding: 20px; }
        .sidebar h1 { font-size: 20px; margin-bottom: 30px; }
        .sidebar nav a { display: block; padding: 12px; margin-bottom: 5px; color: white; text-decoration: none; border-radius: 5px; transition: all 0.3s; }
        .sidebar nav a:hover, .sidebar nav a.active { background: #34495e; }
        
        /* Main Content */
        .main { margin-left: 250px; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h2 { font-size: 24px; margin-bottom: 5px; }
        .header p { color: #7f8c8d; }
        
        /* Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h3 { font-size: 18px; margin-bottom: 15px; color: #2c3e50; }
        
        /* Upload Zone */
        .upload-zone { border: 2px dashed #3498db; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .upload-zone:hover { background: #ecf0f1; }
        
        /* Forms */
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button:hover { background: #2980b9; }
        button.secondary { background: #95a5a6; }
        button.danger { background: #e74c3c; }
        button.success { background: #27ae60; }
        
        /* Task Items */
        .task-item { padding: 12px; border-left: 3px solid #3498db; margin-bottom: 8px; background: #f8f9fa; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .task-item:hover { background: #e9ecef; }
        .task-item.urgent { border-left-color: #e74c3c; }
        .task-item.high { border-left-color: #f39c12; }
        .task-item.pending { background: #fff3cd; border-left-color: #ffc107; }
        .task-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; color: #2c3e50; }
        .task-meta { font-size: 12px; color: #7f8c8d; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .task-full { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd; font-size: 13px; color: #555; }
        
        /* Status Badge */
        .badge { display: inline-block; padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        .badge.idle { background: #2ecc71; color: white; }
        .badge.processing { background: #f39c12; color: white; }
        .badge.pending { background: #ffc107; color: black; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tabs button { background: none; border: none; padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tabs button.active { border-bottom-color: #3498db; color: #3498db; }
        
        /* Page Sections */
        .page { display: none; }
        .page.active { display: block; }
        
        /* Meeting Mode Toggle */
        .toggle { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ecc71; }
        input:checked + .slider:before { transform: translateX(26px); }
        
        /* List */
        .list-item { padding: 10px; border-bottom: 1px solid #eee; }
        .list-item:hover { background: #f8f9fa; }
        
        /* Alert */
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .alert.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h1>üîí CortexDesk</h1>
        <nav>
            <a href="#" class="nav-link active" data-page="dashboard">üìä Dashboard</a>
            <a href="#" class="nav-link" data-page="tasks">‚úÖ Tasks</a>
            <a href="#" class="nav-link" data-page="meetings">üé§ Meetings</a>
            <a href="#" class="nav-link" data-page="research">üîç Research</a>
            <a href="#" class="nav-link" data-page="confirmations">‚è≥ Confirmations</a>
            <a href="#" class="nav-link" data-page="inbox">üì• Inbox</a>
            <a href="#" class="nav-link" data-page="settings">‚öôÔ∏è Settings</a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <div class="header">
                <h2>Dashboard</h2>
                <p>100% Offline | Privacy-First | No Cloud Calls</p>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>üìÑ Upload Document</h3>
                    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                        <p>Click to upload or drag & drop</p>
                        <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">PDF, DOCX, XLSX, TXT, PPTX</p>
                    </div>
                    <input type="file" id="fileInput" style="display: none;" onchange="uploadFile()" accept=".pdf,.docx,.xlsx,.txt,.pptx">
                </div>

                <div class="card">
                    <h3>üìù Manual Entry</h3>
                    <textarea id="manualText" rows="4" placeholder="Paste meeting notes, emails, or any text..."></textarea>
                    <button onclick="processManualText()">Process Text</button>
                </div>

                <div class="card">
                    <h3>üé§ Live Meeting Mode</h3>
                    <p style="margin-bottom: 15px;">Record and transcribe meetings in real-time</p>
                    <label class="toggle">
                        <input type="checkbox" id="meetingToggle" onchange="toggleMeeting()">
                        <span class="slider"></span>
                    </label>
                    <span id="meetingStatus" style="margin-left: 10px;">OFF</span>
                </div>

                <div class="card">
                    <h3>üìä Quick Stats</h3>
                    <div id="stats">
                        <p>Pending Confirmations: <strong id="pendingCount">0</strong></p>
                        <p>Active Tasks: <strong id="taskCount">0</strong></p>
                        <p>Documents Processed: <strong id="docCount">0</strong></p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ü§ñ Agent Status</h3>
                <div id="agentStatus">Loading...</div>
            </div>
        </div>

        <!-- Tasks Page -->
        <div id="tasks" class="page">
            <div class="header">
                <h2>Tasks</h2>
                <p>Manage your action items</p>
            </div>

            <div class="tabs">
                <button class="active" onclick="filterTasks('all')">All</button>
                <button onclick="filterTasks('urgent')">Urgent</button>
                <button onclick="filterTasks('high')">High</button>
                <button onclick="filterTasks('today')">Today</button>
            </div>

            <div class="card">
                <div id="taskList">No tasks yet.</div>
            </div>
        </div>

        <!-- Meetings Page -->
        <div id="meetings" class="page">
            <div class="header">
                <h2>Meetings</h2>
                <p>Meeting summaries and decisions</p>
            </div>

            <div class="card">
                <div id="meetingList">No meetings recorded.</div>
            </div>
        </div>

        <!-- Research Page -->
        <div id="research" class="page">
            <div class="header">
                <h2>Research Workspace</h2>
                <p>Semantic search over your documents</p>
            </div>

            <div class="card">
                <h3>üîç Search Documents</h3>
                <input type="text" id="searchQuery" placeholder="Ask a question or search for information...">
                <button onclick="searchDocuments()">Search</button>
                <div id="searchResults" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Confirmations Page -->
        <div id="confirmations" class="page">
            <div class="header">
                <h2>Pending Confirmations</h2>
                <p>Review and approve AI-extracted items</p>
            </div>

            <div class="card">
                <div id="confirmationList">No pending confirmations.</div>
            </div>
        </div>

        <!-- Inbox Page -->
        <div id="inbox" class="page">
            <div class="header">
                <h2>Inbox</h2>
                <p>AI-detected items from all sources</p>
            </div>

            <div class="card">
                <div id="inboxList">Inbox is empty.</div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <div class="header">
                <h2>Settings</h2>
                <p>Configure your workspace</p>
            </div>

            <div class="card">
                <h3>üîí Privacy & Security</h3>
                <p>‚úÖ 100% Local Processing</p>
                <p>‚úÖ Encrypted Storage</p>
                <p>‚úÖ No Cloud Calls</p>
                <p>‚úÖ Offline-First</p>
            </div>

            <div class="card">
                <h3>‚öôÔ∏è System Info</h3>
                <div id="systemInfo">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8001';

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.dataset.page;
                
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                
                document.getElementById(page).classList.add('active');
                link.classList.add('active');
                
                loadPageData(page);
            });
        });

        // Upload File
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                showAlert('success', `File uploaded: ${data.filename}`);
                setTimeout(() => {
                    loadStats();
                    loadConfirmations();
                }, 2000);
            } catch (error) {
                showAlert('error', 'Error uploading file: ' + error.message);
            }
        }

        // Process Manual Text
        async function processManualText() {
            const textarea = document.getElementById('manualText');
            const text = textarea.value.trim();
            
            console.log('[Manual Entry] Starting process');
            console.log('[Manual Entry] Text length:', text.length);
            
            if (!text) {
                showAlert('error', 'Please enter some text');
                return;
            }

            showAlert('info', 'Processing text...');
            
            try {
                // Create FormData with text file
                const formData = new FormData();
                const blob = new Blob([text], { type: 'text/plain' });
                const timestamp = new Date().getTime();
                const filename = `manual_entry_${timestamp}.txt`;
                const file = new File([blob], filename, { type: 'text/plain' });
                formData.append('file', file);
                
                console.log('[Manual Entry] Uploading:', filename);

                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('[Manual Entry] Response status:', response.status);
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('[Manual Entry] Error response:', error);
                    throw new Error(error.detail || 'Upload failed');
                }
                
                const data = await response.json();
                console.log('[Manual Entry] Success:', data);
                showAlert('success', '‚úì Text processed successfully!');
                textarea.value = '';
                
                // Reload data after 3 seconds
                console.log('[Manual Entry] Waiting 3s before refresh');
                setTimeout(() => {
                    console.log('[Manual Entry] Refreshing data');
                    loadStats();
                    loadConfirmations();
                }, 3000);
            } catch (error) {
                console.error('[Manual Entry] Error:', error);
                showAlert('error', 'Error: ' + error.message);
            }
        }

        // Toggle Meeting Mode
        let meetingRecording = false;
        let meetingStartTime = null;
        
        function toggleMeeting() {
            const toggle = document.getElementById('meetingToggle');
            const status = document.getElementById('meetingStatus');
            
            meetingRecording = toggle.checked;
            
            if (meetingRecording) {
                meetingStartTime = new Date();
                status.textContent = 'RECORDING';
                status.style.color = '#27ae60';
                status.style.fontWeight = 'bold';
                showAlert('success', 'üé§ Meeting recording started');
                
                // Start recording timer
                updateMeetingTimer();
            } else {
                status.textContent = 'OFF';
                status.style.color = '#95a5a6';
                status.style.fontWeight = 'normal';
                
                if (meetingStartTime) {
                    const duration = Math.floor((new Date() - meetingStartTime) / 1000);
                    showAlert('info', `Meeting stopped. Duration: ${duration}s`);
                    meetingStartTime = null;
                }
            }
        }
        
        function updateMeetingTimer() {
            if (!meetingRecording) return;
            
            const status = document.getElementById('meetingStatus');
            const duration = Math.floor((new Date() - meetingStartTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            status.textContent = `RECORDING ${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            setTimeout(updateMeetingTimer, 1000);
        }

        // Search Documents
        async function searchDocuments() {
            const query = document.getElementById('searchQuery').value;
            if (!query) {
                showAlert('error', 'Please enter a search query');
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<p style="color: #7f8c8d;">Searching...</p>';

            try {
                const response = await fetch(`${API_URL}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                
                if (!response.ok) throw new Error('Search failed');
                
                const data = await response.json();
                
                // Show search initiated message
                resultsDiv.innerHTML = `
                    <div class="alert info">
                        ‚úì Search completed for: "${query}"<br>
                        <small>Results are being processed. Check the vector database for semantic matches.</small>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                        <strong>Search Tips:</strong>
                        <ul style="margin-top: 8px; margin-left: 20px; font-size: 13px;">
                            <li>Upload documents first to build the search index</li>
                            <li>Use natural language queries</li>
                            <li>Search works across all uploaded documents</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<p class="alert error">Search failed: ${error.message}</p>`;
            }
        }

        // Load Page Data
        function loadPageData(page) {
            switch(page) {
                case 'dashboard':
                    loadStats();
                    loadAgentStatus();
                    break;
                case 'tasks':
                    loadTasks();
                    break;
                case 'confirmations':
                    loadConfirmations();
                    break;
                case 'meetings':
                    loadMeetings();
                    break;
            }
        }

        // Load Stats
        async function loadStats() {
            try {
                const [tasks, confirmations] = await Promise.all([
                    fetch(`${API_URL}/tasks`).then(r => r.json()),
                    fetch(`${API_URL}/confirmations`).then(r => r.json())
                ]);
                
                document.getElementById('taskCount').textContent = tasks.count || 0;
                document.getElementById('pendingCount').textContent = confirmations.count || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load Tasks
        async function loadTasks() {
            try {
                const response = await fetch(`${API_URL}/tasks`);
                const data = await response.json();
                
                const taskList = document.getElementById('taskList');
                if (data.tasks.length === 0) {
                    taskList.innerHTML = '<p>No tasks found.</p>';
                    return;
                }

                taskList.innerHTML = data.tasks.map((task, index) => {
                    const taskText = task.task.length > 100 ? task.task.substring(0, 100) + '...' : task.task;
                    const showExpand = task.task.length > 100;
                    return `
                        <div class="task-item ${task.priority || 'normal'}" id="task-${index}">
                            <div onclick="toggleTask(${index})">
                                <div class="task-title">${taskText} ${showExpand ? '<span style="color: #3498db; font-size: 11px;">[click to expand]</span>' : ''}</div>
                                <div class="task-full" id="task-full-${index}">${task.task}</div>
                            </div>
                            <div class="task-meta">
                                <span>üë§ ${task.assignee || 'Unassigned'}</span>
                                <span>üéØ ${task.priority || 'normal'}</span>
                                ${task.deadline ? `<span>üìÖ ${task.deadline}</span>` : ''}
                                <button onclick="event.stopPropagation(); deleteTask(${index})" style="background: #e74c3c; padding: 4px 8px; font-size: 11px;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        // Load Confirmations
        async function loadConfirmations() {
            try {
                const response = await fetch(`${API_URL}/confirmations`);
                const data = await response.json();
                
                const list = document.getElementById('confirmationList');
                if (data.pending.length === 0) {
                    list.innerHTML = '<p>No pending confirmations.</p>';
                    return;
                }

                list.innerHTML = data.pending.map(item => {
                    const task = item.data.task || 'Item';
                    const shortTask = task.length > 100 ? task.substring(0, 100) + '...' : task;
                    const assignee = item.data.assignee || 'Unassigned';
                    const deadline = item.data.deadline || 'No deadline';
                    const confidence = Math.round(item.confidence * 100);
                    
                    return `
                    <div class="task-item pending" style="margin-bottom: 15px;">
                        <div class="task-title">${shortTask}</div>
                        <div class="task-meta" style="margin: 8px 0;">
                            <span>üë§ ${assignee}</span>
                            <span>üìÖ ${deadline}</span>
                            <span>üéØ ${confidence}% confidence</span>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="success" onclick="approveItem('${item.id}')" style="margin-right: 5px;">‚úì Approve</button>
                            <button class="danger" onclick="rejectItem('${item.id}')">‚úó Reject</button>
                        </div>
                    </div>
                `}).join('');
                
                document.getElementById('pendingCount').textContent = data.count;
            } catch (error) {
                console.error('Error loading confirmations:', error);
            }
        }

        // Approve Item
        async function approveItem(itemId) {
            try {
                await fetch(`${API_URL}/confirmations/${itemId}/approve`, { method: 'POST' });
                showAlert('success', 'Item approved!');
                loadConfirmations();
                loadTasks();
            } catch (error) {
                showAlert('error', 'Error approving item');
            }
        }

        // Reject Item
        async function rejectItem(itemId) {
            try {
                await fetch(`${API_URL}/confirmations/${itemId}/reject`, { method: 'POST' });
                showAlert('success', 'Item rejected');
                loadConfirmations();
            } catch (error) {
                showAlert('error', 'Error rejecting item');
            }
        }

        // Load Agent Status
        async function loadAgentStatus() {
            try {
                const response = await fetch(`${API_URL}/status`);
                const data = await response.json();
                
                const statusDiv = document.getElementById('agentStatus');
                statusDiv.innerHTML = Object.entries(data).map(([agent, status]) => `
                    <div class="list-item">
                        <strong>${agent.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong>
                        <span class="badge ${status}">${status}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Load Meetings
        async function loadMeetings() {
            try {
                const response = await fetch(`${API_URL}/memory/recent?days=30`);
                const data = await response.json();
                
                const meetingList = document.getElementById('meetingList');
                
                if (!data.episodes || data.episodes.length === 0) {
                    meetingList.innerHTML = '<p>No meetings recorded yet. Upload meeting notes to see them here.</p>';
                    return;
                }
                
                meetingList.innerHTML = '<p>Upload meeting documents to see them here. Go to Dashboard and upload a file.</p>';
            } catch (error) {
                console.error('Error loading meetings:', error);
                document.getElementById('meetingList').innerHTML = '<p>Upload meeting notes to see them here.</p>';
            }
        }

        // Filter Tasks
        function filterTasks(filter) {
            document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            loadTasks();
        }

        // Show Alert
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            document.querySelector('.main').insertBefore(alert, document.querySelector('.main').firstChild);
            setTimeout(() => alert.remove(), 5000);
        }
        
        // Delete Task
        async function deleteTask(index) {
            if (!confirm('Delete this task?')) return;
            
            // Remove from UI immediately
            const taskElement = document.getElementById(`task-${index}`);
            if (taskElement) {
                taskElement.remove();
                showAlert('success', '‚úì Task deleted');
            }
            
            // Remove from backend
            try {
                const response = await fetch(`${API_URL}/tasks/${index}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadStats();
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        }
        
        // Toggle Task Full Text
        function toggleTask(index) {
            const fullText = document.getElementById(`task-full-${index}`);
            if (fullText) {
                fullText.style.display = fullText.style.display === 'block' ? 'none' : 'block';
            }
        }

        // Initialize
        loadStats();
        loadAgentStatus();
        setInterval(loadStats, 10000);
        setInterval(loadAgentStatus, 5000);
    </script>
</body>
</html>
